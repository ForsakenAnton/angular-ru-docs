# Создание библиотек

Вы можете создавать и публиковать новые библиотеки для расширения функциональности Angular. Если вы обнаружите, что вам нужно решить одну и ту же проблему в нескольких приложениях (или вы хотите поделиться своим решением с другими разработчиками), у вас есть кандидат в библиотеку.

Простым примером может служить кнопка, которая отправляет пользователей на веб-сайт вашей компании, которая будет включена во все приложения, создаваемые вашей компанией.

<div class="alert is-helpful">
     <p>Для получения более подробной информации о том, как проект библиотеки структурирована вы можете передать #библиотеку-проект-файлы "> Библиотека файлов проекта</p>
</div>

{@a getting-started}
## Начало работы

Используйте Angular CLI для создания новой библиотеки скелета с помощью следующей команды:

<code-example language="bash">
 ng new my-workspace --create-application=false
 cd my-workspace
 ng generate library my-lib
</code-example>

<div class="alert is-helpful">
     <p>Вы можете использовать модель monorepo, чтобы использовать одно и то же рабочее пространство для нескольких проектов. См #несколько-проектов "> Настройка для рабочей области с несколькими проектами</p>
</div>

Это создает `projects/my-lib` Папка в вашей рабочей области, которая содержит компонент и сервис внутри NgModule.
Файл конфигурации рабочей области, `angular.json`, обновляется проектом типа «библиотека».

<code-example format="json">
"projects": {
  ...
  "my-lib": {
    "root": "projects/my-lib",
    "sourceRoot": "projects/my-lib/src",
    "projectType": "library",
    "prefix": "lib",
    "architect": {
      "build": {
        "builder": "@angular-devkit/build-ng-packagr:build",
        ...
</code-example>

Вы можете создавать, тестировать и ворс проекта с командами CLI:

<code-example language="bash">
 ng build my-lib
 ng test my-lib
 ng lint my-lib
</code-example>

Обратите внимание, что настроенный компоновщик для проекта отличается от компоновщика по умолчанию для проектов приложений.
Этот конструктор, помимо прочего, гарантирует, что библиотека всегда с помощью [компилятора AOT](guide/aot-compiler)собирается, без необходимости указывать `--prod` флаг.

Чтобы сделать код библиотеки повторно используемым, вы должны определить для него публичный API. Этот «пользовательский слой» определяет, что доступно потребителям вашей библиотеки. Пользователь вашей библиотеки должен иметь доступ к общедоступным функциям (таким как NgModules, поставщики услуг и общие функции утилит) через единый путь импорта.

Публичный API для вашей библиотеки поддерживается в `public-api.ts` Файл в вашей папке библиотеки.
Все, что экспортируется из этого файла, становится общедоступным, когда ваша библиотека импортируется в приложение.
Используйте NgModule для предоставления услуг и компонентов.

Ваша библиотека должна предоставить документацию (обычно файл README) для установки и обслуживания.

{@a refactoring-parts-of-an-app-into-a-library}
## Рефакторинг частей приложения в библиотеку

Чтобы сделать ваше решение многоразовым, вам нужно настроить его так, чтобы оно не зависело от кода приложения.
Вот некоторые вещи, которые следует учитывать при переносе функциональности приложения в библиотеку.

* Такие объявления, как компоненты и каналы, должны проектироваться как не имеющие состояния, то есть они не зависят от внешних переменных и не изменяют их. Если вы полагаетесь на состояние, вам нужно оценить каждый случай и решить, будет ли это состояние приложения или состояние, которым будет управлять библиотека.

* Любые наблюдаемые, на которые компоненты подписываются внутри, должны быть очищены и утилизированы в течение жизненного цикла этих компонентов.

* Компоненты должны раскрывать свои взаимодействия через входные данные для обеспечения контекста и выходные данные для передачи событий другим компонентам.

* Службы должны объявлять своих собственных провайдеров (а не объявлять провайдеров в модуле NgModule или компоненте), чтобы их можно было использовать в виде*дерева.*, Это позволяет компилятору оставить сервис вне пакета, если он никогда не внедряется в приложение, импортирующее библиотеку. Для получения дополнительной информации об этом см. [Поставщики с возможностью поиска по дереву](guide/dependency-injection-providers#tree-shakable-providers).

* Если вы регистрируете глобальных поставщиков услуг или совместно используете поставщиков через несколько NgModules, используйте шаблоны [ `forRoot ()` и `forChild ()` ](guide/singleton-services)предоставленные [RouterModule](api/router/RouterModule).

* Проверьте все внутренние зависимости.
   * Для пользовательских классов или интерфейсов, используемых в компонентах или службе, проверьте, зависят ли они от дополнительных классов или интерфейсов, которые также необходимо перенести.
   * Точно так же, если код вашей библиотеки зависит от службы, ее необходимо перенести.
   * Если код вашей библиотеки или ее шаблоны зависят от других библиотек (например, Angular Material), вы должны настроить свою библиотеку на эти зависимости.

{@a reusable-code-and-schematics}
## Многоразовый код и схемы

Библиотека обычно включает в себя *повторно используемый код,* который определяет компоненты, сервисы и другие Angular артефакты (каналы, директивы и т. Д.), Которые вы просто импортируете в проект.
Библиотека упакована в пакет npm для публикации и обмена, и этот пакет также может включать [схемы](guide/glossary#schematic)которые предоставляют инструкции для генерации или преобразования кода непосредственно в вашем проекте, точно так же, как CLI создает общее скелетное приложение с `ng generate component`.
Схема, объединенная с библиотекой, может, например, предоставить Angular CLI информацию, необходимую для создания определенного компонента, определенного в этой библиотеке.

То, что вы включаете в свою библиотеку, определяется типом задачи, которую вы пытаетесь выполнить.
Например, если вы хотите, чтобы раскрывающийся список с некоторыми стандартными данными показывал, как добавить его в ваше приложение, ваша библиотека может определить схему для его создания.
Для такого компонента, как раскрывающийся список, который будет каждый раз содержать переданные значения, вы можете предоставить его в качестве компонента в общей библиотеке.

Предположим, вы хотите прочитать файл конфигурации, а затем сгенерировать форму на основе этой конфигурации.
Если эта форма потребует дополнительной настройки пользователем, она может работать лучше в виде схемы.
Однако, если формы всегда будут одинаковыми и не требуют особой настройки разработчиками, тогда вы можете создать динамический компонент, который принимает конфигурацию и генерирует форму.
В общем, чем сложнее настройка, тем полезнее схематический подход.

{@a integrating-with-the-cli}

{@a integrating-with-the-cli}
## Интеграция с CLI

Библиотека может включать [схемы](guide/glossary#schematic)которые позволяют ей интегрироваться с Angular CLI.

* Включите схему установки, чтобы `ng add` может добавить вашу библиотеку в проект.

* Включите схемы генерации в вашу библиотеку, чтобы `ng generate` может ваши определенные артефакты (компоненты, сервисы, тесты и т. д.) в проекте.

* Включите схему обновления, чтобы `ng update` может обновлять зависимости вашей библиотеки и обеспечивать миграцию для прерывания изменений в новых выпусках.

Чтобы узнать больше, см. [Обзор схем](guide/schematics)и [Схемы для библиотек](guide/schematics-for-libraries).

{@a publishing-your-library}
## Публикация вашей библиотеки

Используйте Angular CLI и менеджер пакетов npm, чтобы собрать и опубликовать вашу библиотеку как пакет npm. Не рекомендуется публиковать библиотеки Ivy в репозиториях NPM. Перед публикацией библиотеки в NPM создайте ее, используя `--prod` флаг, который будет использовать более старый компилятор и среду выполнения, известную как View Engine вместо Ivy.

<code-example language="bash">
ng build my-lib --prod
cd dist/my-lib
npm publish
</code-example>

Если вы никогда ранее не публиковали пакет в npm, вы должны создать учетную запись пользователя. Подробнее читайте в [Публикация пакетов npm](https://docs.npmjs.com/getting-started/publishing-npm-packages).

{@a lib-assets}

{@a managing-assets-in-a-library}
## Управление активами в библиотеке

Начиная с версии 9.x [ng-packagr](https://github.com/ng-packagr/ng-packagr/blob/master/README.md)инструмента, вы можете сконфигурировать инструмент для автоматического копирования ресурсов в ваш библиотечный пакет как часть процесса сборки.
Вы можете использовать эту функцию, когда вашей библиотеке требуется опубликовать необязательные тематические файлы, миксины Sass или документацию (например, журнал изменений).

* Узнайте, как [скопировать ресурсы в вашу библиотеку как часть сборки](https://github.com/ng-packagr/ng-packagr/blob/master/docs/copy-assets.md).

* Узнайте больше о том, как использовать этот инструмент для [встраивания ресурсов в CSS](https://github.com/ng-packagr/ng-packagr/blob/master/docs/embed-assets-css.md).


{@a linked-libraries}
## Связанные библиотеки

Работая над опубликованной библиотекой, вы можете использовать [ссылка на npm](https://docs.npmjs.com/cli/link)чтобы избежать переустановки библиотеки при каждой сборке.

Библиотека должна быть перестроена при каждом изменении.
При подключении библиотеки убедитесь, что этап сборки выполняется в режиме просмотра и что библиотека `package.json` Конфигурация указывает на правильные точки входа.
Например, `main` должен указывать на файл JavaScript, а не файл TypeScript.

{@a use-typescript-path-mapping-for-peer-dependencies}
## Используйте отображение пути TypeScript для одноранговых зависимостей

Angular библиотеки должны перечислить все `@angular/*` зависимости как одноранговые зависимости.
Это гарантирует, что когда модули запрашивают Angular, все они получают один и тот же модуль.
Если библиотека перечисляет `@angular/core` в `dependencies` вместо `peerDependencies`, этого он может получить другой модуль Angular, что приведет к поломке вашего приложения.

При разработке библиотеки вы должны установить все одноранговые зависимости через `devDependencies` для обеспечения правильной компиляции библиотеки.
Связанная библиотека будет тогда иметь свой собственный набор библиотек Angular, который она использует для сборки, расположенную в ее `node_modules` папка.
Однако это может вызвать проблемы при сборке или запуске приложения.

Чтобы обойти эту проблему, вы можете использовать отображение пути TypeScript, чтобы сообщить TypeScript, что он должен загружать некоторые модули из определенного места.
Перечислите все одноранговые зависимости, которые ваша библиотека использует, в файле конфигурации TypeScript рабочей области. `./tsconfig.json` и укажите их на локальную копию в приложении `node_modules` папка.

```
{
  "compilerOptions": {
    // ...
    // paths are relative to `baseUrl` path.
    "paths": {
      "@angular/*": [
        "./node_modules/@angular/*"
      ]
    }
  }
}
```

Это отображение гарантирует, что ваша библиотека всегда загружает локальные копии необходимых ей модулей.


{@a using-your-own-library-in-apps}
## Использование вашей собственной библиотеки в приложениях

Вам не нужно публиковать свою библиотеку в менеджере пакетов npm, чтобы использовать ее в своих собственных приложениях, но сначала вам нужно ее собрать.

Для того, чтобы использовать свою собственную библиотеку в приложении:

* Постройте библиотеку. Вы не можете использовать библиотеку до ее создания.
 <code-example language="bash">
 ng build my-lib
 </code-example>

* В приложениях, импортировать из библиотеки по имени:
 ```
 import { myExport } from 'my-lib';
 ```

{@a building-and-rebuilding-your-library}
### Сборка и перестройка вашей библиотеки

Шаг сборки важен, если вы не опубликовали свою библиотеку как пакет npm, а затем установили пакет обратно в приложение из npm.
Например, если вы клонируете свой репозиторий git и запускаете `npm install`, ваш редактор покажет `my-lib` импортирует как отсутствующие, если вы еще не создали свою библиотеку.

<div class="alert is-helpful">

Когда вы импортируете что-то из библиотеки в приложении Angular, Angular ищет соответствие между именем библиотеки и местоположением на диске.
Когда вы устанавливаете пакет библиотеки, отображение находится в `node_modules` папка . Когда вы создаете свою собственную библиотеку, она должна найти отображение в вашем `tsconfig` пути.

Генерация библиотеки с помощью Angular CLI автоматически добавляет ее путь к `tsconfig` файл.
Angular CLI использует `tsconfig` Пути чтобы сообщить системе сборки, где найти библиотеку.

</div>

Если вы обнаружите, что изменения в вашей библиотеке не отражены в вашем приложении, ваше приложение, вероятно, использует старую сборку библиотеки.

Вы можете перестраивать свою библиотеку всякий раз, когда вносите в нее изменения, но этот дополнительный шаг требует времени.
*Добавочная сборки* функциональность улучшает опыт разработки библиотеки.
Каждый раз, когда файл изменяется, выполняется частичная сборка, которая генерирует исправленные файлы.

Инкрементные сборки можно запускать как фоновый процесс в вашей среде разработки. Чтобы воспользоваться этой функцией, добавьте `--watch` флаг команды сборки:

<code-example language="bash">
ng build my-lib --watch
</code-example>

<div class="alert is-important">

CLI `build` Команда использует другой компоновщик и вызывает другой инструмент компоновки для библиотек, чем для приложений.

* Система сборки для приложений, `@angular-devkit/build-angular`, основан на `webpack`, и входит во все новые проекты Angular CLI.
* Система сборки для библиотек основана на `ng-packagr` . Он добавляется к вашим зависимостям только при добавлении библиотеки с помощью `ng generate library my-lib`.

Две системы сборки поддерживают разные вещи, и даже если они поддерживают одни и те же вещи, они делают эти вещи по-разному.
Это означает, что источник TypeScript может привести к другому коду JavaScript во встроенной библиотеке, чем во встроенном приложении.

По этой причине приложение, зависящее от библиотеки, должно использовать только сопоставления путей TypeScript, указывающие на *встроенную библиотеку*.
Отображения пути TypeScript должны *не* указывать на источник библиотеки `.ts` файлы.

</div>
