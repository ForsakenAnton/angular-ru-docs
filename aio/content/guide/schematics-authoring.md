{@a authoring-schematics}
# Авторские схемы

Вы можете создавать свои собственные схемы для работы над проектами Angular.
Разработчики библиотек обычно объединяют схемы со своими библиотеками, чтобы интегрировать их с Angular CLI.
Вы также можете создавать автономные схемы для управления файлами и конструкциями в приложениях Angular, чтобы настроить их для своей среды разработки и привести их в соответствие с вашими стандартами и ограничениями.
Схемы могут быть связаны, используя другие схемы для выполнения сложных операций.

Управление кодом в приложении может быть очень мощным и, соответственно, опасным.
Например, создание файла, который уже существует, будет ошибкой, и если он будет применен немедленно, он отменит все остальные изменения, примененные до сих пор.
Инструменты Angular Schematics защищают от побочных эффектов и ошибок, создавая виртуальную файловую систему.
Схема описывает конвейер преобразований, которые можно применить к виртуальной файловой системе.
Когда схема выполняется, преобразования записываются в память и применяются в реальной файловой системе только после подтверждения их правильности.

{@a schematics-concepts}
## Схематические понятия

Открытый API для схем определяет классы, которые представляют основные понятия.

* Виртуальная файловая система представлена  `Tree` .  `Tree` структура данных содержит*базу * (набор файлов, который уже существует) и*промежуточную область * (список изменений, которые должны быть применены к базе).
При внесении изменений вы фактически не меняете базу, а добавляете эти модификации в область подготовки.

*  `Rule` Объект определяет функцию, которая принимает  `Tree`, применяет преобразования и возвращает новый  `Tree`  . Основной файл для схемы,  `index.ts`, определяет набор правил, которые реализуют логику схемы.

* Преобразование представлено  `Action`  . Есть четыре типа действий:  `Create`, `Rename`, `Overwrite`  и  `Delete`.

* Каждая схема работает в контексте, представленном  `SchematicContext`  Объект.

Объект контекста, переданный в правило, обеспечивает доступ к служебным функциям и метаданным, с которыми может потребоваться работа схемы, включая API ведения журнала для помощи в отладке.
Контекст также определяет *стратегию слияния,* которая определяет, как изменения объединяются из поэтапного дерева в базовое дерево. Изменение может быть принято или проигнорировано, или выдать исключение.

{@a defining-rules-and-actions}
### Определение правил и действий

Когда вы создаете новую пустую схему с помощью [Schematics CLI](#cli), сгенерированная функция ввода является *фабрикой правил*.
 `RuleFactory` Объект определяет функцию высшего порядка, которая создает  `Rule`.

<code-example language="TypeScript" header="index.ts">
import { Rule, SchematicContext, Tree } from '@angular-devkit/schematics';

// You don't have to export the function as default.
// You can also have more than one rule factory per file.
export function helloWorld(_options: any): Rule {
 return (tree: Tree, _context: SchematicContext) => {
   return tree;
 };
}
</code-example>

Ваши правила могут вносить изменения в ваши проекты, вызывая внешние инструменты и реализуя логику.
Например, вам нужно правило, чтобы определить, как шаблон схемы должен быть объединен с хост-проектом.

Правила могут использовать утилиты, предоставляемые с  `@schematics/angular`  пакет. Ищите вспомогательные функции для работы с модулями, зависимостями, TypeScript, AST, JSON, рабочими пространствами и проектами Angular CLI и многим другим.

<code-example language="TypeScript" header="index.ts">

import {
  JsonAstObject,
  JsonObject,
  JsonValue,
  Path,
  normalize,
  parseJsonAst,
  strings,
} from '&#64;angular-devkit/core';

</code-example>

{@a defining-input-options-with-a-schema-and-interfaces}
### Определение параметров ввода со схемой и интерфейсами

Правила могут собирать значения параметров из вызывающей стороны и вставлять их в шаблоны.
Параметры, доступные для ваших правил, с их допустимыми значениями и значениями по умолчанию, определены в файле схемы JSON схемы,  `<schematic>/schema.json`.
Вы можете определить переменные или перечисляемые типы данных для схемы, используя интерфейсы TypeScript.

Схема определяет типы и значения переменных по умолчанию, используемые в схеме.
Например, гипотетическая схема «Hello World» может иметь следующую схему.

<code-example language="json" header="src/hello-world/schema.json">

{
    "properties": {
        "name": {
            "type": "string",
            "minLength": 1,
            "default": "world"
        },
        "useColor": {
            "type": "boolean"
        }
    }
}
</code-example>


Вы можете увидеть примеры файлов схемы для схем команд Angular CLI в [ `@ schematics / angular` ](https://github.com/angular/angular-cli/blob/7.0.x/packages/schematics/angular/application/schema.json).

{@a schematic-prompts}
### Схематические подсказки

Схематические *подсказки* вводят взаимодействие пользователя в схематическое исполнение.
Вы можете настроить параметры схемы для отображения настраиваемого вопроса пользователю.
Подсказки отображаются перед выполнением схемы, которая затем использует ответ в качестве значения параметра.
Это позволяет пользователям управлять работой схемы, не требуя глубокого знания всего спектра доступных опций.

Схема «Hello World» может, например, запрашивать у пользователя его имя и отображать это имя вместо имени по умолчанию «world». Чтобы определить такую ​​подсказку, добавьте  `x-prompt`  Свойство для схемы для  `name`  переменная

Точно так же вы можете добавить приглашение, позволяющее пользователю решать, будет ли схема использовать цвет при выполнении своего действия приветствия. Схема с обоими запросами будет выглядеть следующим образом.

<code-example language="json" header="src/hello-world/schema.json">

{
    "properties": {
        "name": {
            "type": "string",
            "minLength": 1,
            "default": "world",
            "x-prompt": "What is your name?"
        },
        "useColor": {
            "type": "boolean",
            "x-prompt": "Would you like the response in color?"
        }
    }
}
</code-example>

{@a prompt-short-form-syntax}
#### Подскажите краткий синтаксис

В этих примерах используется сокращенная форма синтаксиса приглашения, содержащая только текст вопроса.
В большинстве случаев это все, что требуется.
Однако обратите внимание, что эти два запроса ожидают разные типы ввода.
При использовании сокращенной формы наиболее подходящий тип выбирается автоматически на основе схемы свойства.
В примере  `name`  подсказка использует  `input`  тип потому что это строковое свойство.
 `useColor` подсказка использует  `confirmation`  тип потому что это логическое свойство.
В этом случае «да» соответствует  `true`  и "нет" соответствует  `false`.

Есть три поддерживаемых типа ввода.

| Тип входа | Описание |
| : ----------- | : ------------------- |
| подтверждение | Да или нет вопрос; идеально подходит для булевых опций. |
| вход | Текстовый ввод; идеально подходит для строк или чисел. |
| список | Предопределенный набор допустимых значений. |

В краткой форме тип выводится из типа свойства и ограничений.

| Схема недвижимости | Тип подсказки |
| : --------------- | : ------------- |
| "type": "boolean" | подтверждение («да» =  `true`, "нет" =  `false`) |
| "тип": "строка" | вход |
| "тип": "номер" | ввод (принимаются только действительные числа) |
| "тип": "целое число" | ввод (принимаются только действительные числа) |
| "enum": [...] | список (члены перечисления становятся списком выбора) |

В следующем примере свойство принимает перечисляемое значение, поэтому схема автоматически выбирает тип списка и создает меню из возможных значений.

<code-example language="json" header="schema.json">

    "style": {
      "description": "The file extension or preprocessor to use for style files.",
      "type": "string",
      "default": "css",
      "enum": [
        "css",
        "scss",
        "sass",
        "less",
        "styl"
      ],
      "x-prompt": "Which stylesheet format would you like to use?"
    }

</code-example>

Среда выполнения приглашения автоматически проверяет предоставленный ответ на соответствие ограничениям, указанным в схеме JSON.
Если значение недопустимо, пользователю предлагается ввести новое значение.
Это гарантирует, что любые значения, переданные в схему, соответствуют ожиданиям реализации схемы, поэтому вам не нужно добавлять дополнительные проверки в код схемы.

{@a prompt-long-form-syntax}
#### Подскажите длинный синтаксис

 `x-prompt` Синтаксис поля поддерживает длинную форму для случаев, когда вам требуется дополнительная настройка и контроль над приглашением.
В этой форме  `x-prompt`  Значение поля - это объект JSON с подполями, которые настраивают поведение приглашения.

| Поле | Значение данных |
| : ----------- | : ------ |
| тип |  `confirmation`, `input`  или  `list`  (выбирается автоматически в краткой форме) |
| сообщение | строка (обязательно) |
| предметы | пара строк и / или меток / значений (действует только с типом  `list`) |

Следующий пример длинной формы взят из схемы JSON для схемы, которую CLI использует для [генерации приложений](https://github.com/angular/angular-cli/blob/ba8a6ea59983bb52a6f1e66d105c5a77517f062e/packages/schematics/angular/application/schema.json#L56).
Он определяет приглашение, которое позволяет пользователям выбирать, какой препроцессор стиля они хотят использовать для создаваемого приложения.
Используя длинную форму, схема может обеспечить более явное форматирование пунктов меню.

<code-example language="json" header="package/schematics/angular/application/schema.json">

    "style": {
      "description": "The file extension or preprocessor to use for style files.",
      "type": "string",
      "default": "css",
      "enum": [
        "css",
        "scss",
        "sass",
        "less",
        "styl"
      ],
      "x-prompt": {
        "message": "Which stylesheet format would you like to use?",
        "type": "list",
        "items": [
          { "value": "css",  "label": "CSS" },
          { "value": "scss", "label": "SCSS   [ https://sass-lang.com/documentation/syntax#scss                ]" },
          { "value": "sass", "label": "Sass   [ https://sass-lang.com/documentation/syntax#the-indented-syntax ]" },
          { "value": "less", "label": "Less   [ http://lesscss.org                                             ]" },
          { "value": "styl", "label": "Stylus [ http://stylus-lang.com                                         ]" }
        ]
      },
    },
</code-example>

{@a x-prompt-schema}
#### Схема х-подсказки

Схема JSON, которая определяет параметры схемы, поддерживает расширения, позволяющие декларативное определение приглашений и их соответствующего поведения.
Никакой дополнительной логики или изменений в коде схемы для поддержки подсказок не требуется.
Следующая схема JSON представляет собой полное описание синтаксиса длинной формы для  `x-prompt`  поле.

<code-example language="json" header="x-prompt schema">

{
    "oneOf": [
        { "type": "string" },
        {
            "type": "object",
            "properties": {
                "type": { "type": "string" },
                "message": { "type": "string" },
                "items": {
                    "type": "array",
                    "items": {
                        "oneOf": [
                            { "type": "string" },
                            {
                                "type": "object",
                                "properties": {
                                    "label": { "type": "string" },
                                    "value": { }
                                },
                                "required": [ "value" ]
                            }
                        ]
                    }
                }
            },
            "required": [ "message" ]
        }
    ]
}

</code-example>

{@a cli}

{@a schematics-cli}
## Схемы CLI

Схемы поставляются с собственным инструментом командной строки.
Использование узла 6.9 или выше, установите средство командной строки схемной глобально:

<code-example language="bash">
npm install -g @angular-devkit/schematics-cli
</code-example>

Это устанавливает  `schematics`  Исполняемый файл, который можно использовать для создания новой коллекции схем в собственной папке проекта, добавления новой схемы в существующую коллекцию или расширения существующей схемы.

В следующих разделах мы создадим новую коллекцию схем с использованием интерфейса командной строки, чтобы представить файлы и структуру файлов, а также некоторые основные понятия.

Однако наиболее распространенным использованием схем является интеграция Angular-библиотеки с Angular CLI.
Это можно сделать, создав файлы схемы непосредственно в проекте библиотеки в рабочей области Angular без использования интерфейса командной строки Schematics.
Смотрите [Схемы для библиотек](guide/schematics-for-libraries).

{@a creating-a-schematics-collection}
### Создание коллекции схем

Следующая команда создает новую схему с именем  `hello-world`  в новой папке проекта с тем же именем.

<code-example language="bash">
schematics blank --name=hello-world
</code-example>

 `blank` схема предоставляется CLI Schematics. Команда создает новую папку проекта (корневую папку для коллекции) и исходное имя схемы в коллекции.

Перейдите в папку коллекции, установите зависимости npm и откройте новую коллекцию в своем любимом редакторе, чтобы увидеть созданные файлы. Например, если вы используете VSCode:

<code-example language="bash">
cd hello-world
npm install
npm run build
code.
</code-example>

Исходная схема получает то же имя, что и папка проекта, и создается в  `src/hello-world`.
Вы можете добавить связанные схемы в эту коллекцию и изменить сгенерированный код скелета, чтобы определить функциональность вашей схемы.
Каждое имя схемы должно быть уникальным в коллекции.

{@a running-a-schematic}
### Запущена схема

Использовать  `schematics`  команда для запуска именованной схемы.
Укажите путь к папке проекта, имя схемы и все обязательные параметры в следующем формате.

<code-example language="bash">
schematics &lt;path-to-schematics-project&gt;:&lt;schematics-name&gt; --&lt;required-option&gt;=&lt;value&gt;
</code-example>

Путь может быть абсолютным или относительным к текущему рабочему каталогу, в котором выполняется команда.
Например, чтобы запустить только что созданную схему (у которой нет обязательных параметров), используйте следующую команду.

<code-example language="bash">
schematics .:hello-world
</code-example>

{@a adding-a-schematic-to-a-collection}
### Добавление схемы в коллекцию

Чтобы добавить схему в существующую коллекцию, используйте ту же команду, которую вы использовали для запуска нового проекта схемы, но выполните команду внутри папки проекта.

<code-example language="bash">
cd hello-world
schematics blank --name=goodbye-world
</code-example>

Команда генерирует новую именованную схему внутри вашей коллекции с основным  `index.ts`  Файл и связанные с ним тестовые спецификации.
Он также добавляет имя, описание и фабричную функцию для новой схемы в схему коллекции в  `collection.json`  файл.

{@a collection-contents}
## Содержание коллекции

Верхний уровень корневой папки проекта для коллекции содержит файлы конфигурации,  `node_modules`  папка и  `src/`  папка.
 `src/` папка содержит подпапки для именованных схем в коллекции и схему,  `collection.json`, который описывает собранные схемы.
Каждая схема создается с именем, описанием и заводской функцией.

<code-example language="none">
{
  "$schema":
     "../node_modules/@angular-devkit/schematics/collection-schema.json",
  "schematics": {
    "hello-world": {
      "description": "A blank schematic.",
      "factory": "./hello-world/index#helloWorld"
    }
  }
}
</code-example>

*  `$schema` Свойство указывает схему, которую CLI использует для проверки.
*  `schematics` списки свойств именами схем, которые принадлежат этой коллекции.
   Каждая схема имеет текстовое описание и указывает на сгенерированную функцию ввода в главном файле.
*  `factory` свойство указывает на сгенерированную функцию входа. В этом примере вы вызываете  `hello-world`  схема, позвонив  `helloWorld()`  фабричная функция.
* Необязательный   `schema` свойство указывает на файл схемы JSON, который определяет параметры командной строки, доступные для схемы.
* Необязательный  `aliases`  массиве указывается одна или несколько строк, которые можно использовать для вызова схемы.
   Например, схема команды Angular CLI «генерировать» имеет псевдоним «g», что позволяет использовать команду `ng g`.

{@a named-schematics}
### Именованные схемы

Когда вы используете CLI Schematics для создания пустого проекта схемы, новая пустая схема является первым членом коллекции и имеет то же имя, что и коллекция.
Когда вы добавляете новую именованную схему в эту коллекцию, она автоматически добавляется в   `collection.json`   схема.

В дополнение к названию и описанию каждая схема имеет  `factory`  свойство, которое идентифицирует точку входа схемы.
В этом примере вы вызываете определенные функциональные возможности схемы, вызывая  `helloWorld()`  функция в главном файле,   `hello-world/index.ts`.

<div class="lightbox">
  <img src="generated/images/guide/schematics/collection-files.gif" alt="overview">
</div>

Каждая именованная схема в коллекции имеет следующие основные части.

| | |
| :------------- | :-------------------------------------------|
|  `index.ts`       | Код, который определяет логику преобразования для именованной схемы. |
|  `schema.json`    | Схематическое определение переменных. |
|  `schema.d.ts`    | Схематические переменные. |
|  `files/`         | Необязательные файлы компонентов / шаблонов для репликации. |

Схема может предоставить всю свою логику в  `index.ts`  Файл, без дополнительных шаблонов.
Однако вы можете создавать динамические схемы для Angular, предоставляя компоненты и шаблоны в  `files/`  папка, как в автономных проектах Angular.
Логика в файле индекса настраивает эти шаблоны, определяя правила, которые вводят данные и изменяют переменные.
